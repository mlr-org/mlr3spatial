<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Parallel spatial prediction for mlr3 • mlr3spatial</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/journal/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.1/css/all.min.css" integrity="sha256-PbSmjxuVAzJ6FPvNYsrXygfGhNJYyZ2GktDbkMBqQZg=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.1/css/v4-shims.min.css" integrity="sha256-A6jcAdwFD48VMjlI3GDxUd+eCQa7/KWy6G9oe/ovaPA=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<link href="extra.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="Parallel spatial prediction for mlr3">
<meta property="og:description" content="Parallel raster prediction for mlr3.">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div class="navbar-brand-container">
        <a href="https://mlr-org.com"><img src="https://raw.githubusercontent.com/mlr-org/mlr3/master/man/figures/logo.png" id="hexlogo" alt="mlr-org"></a>
        <a class="navbar-brand" href="index.html">mlr3spatial <small>v0.0.0.9000</small></a>
      </div>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
<li>
  <a href="reference/index.html">
    <span class="fa fa-file-alt"></span>
     
    Reference
  </a>
</li>
<li>
  <a href="https://mlr3book.mlr-org.com">
    <span class="fa fa-link"></span>
     
    mlr3book
  </a>
</li>
        <li>
  <a href="https://github.com/mlr-org/mlr3spatial/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://lmmisld-lmu-stats-slds.srv.mwn.de/mlr_invite/">
    <span class="fa fa-comments"></span>
     
  </a>
</li>
<li>
  <a href="https://stackoverflow.com/questions/tagged/mlr3">
    <span class="fab fa-stack-overflow"></span>
     
  </a>
</li>
<li>
  <a href="https://mlr-org.com/">
    <span class="fa fa-rss"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">

<div id="mlr3spatial" class="section level1">
<div class="page-header"><h1 class="hasAnchor">
<a href="#mlr3spatial" class="anchor"></a>mlr3spatial</h1></div>
<!-- badges: start -->

<p>This package is <strong>not</strong> ready for production use and only a proof of concept for now. For spatiotemporal resampling support see <a href="https://github.com/mlr-org/mlr3spatiotempcv">mlr3spatiotempcv</a>.</p>
</div>
<div id="proof-of-concept" class="section level1">
<h1 class="hasAnchor">
<a href="#proof-of-concept" class="anchor"></a>Proof of Concept</h1>
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>The prediction of large raster files is an error-prone and time consuming task in R.</p>
<p>This package aims to</p>
<ol>
<li>Allow raster prediction with mlr3 learners</li>
<li>Predict raster files in chunks to prevent memory related errors</li>
<li>Speed up the prediction process by predicting the chunks in parallel</li>
</ol>
</div>
<div id="methods" class="section level2">
<h2 class="hasAnchor">
<a href="#methods" class="anchor"></a>Methods</h2>
<p>The size of raster files in memory can be easily calculated with <code>number of cells * number of layers * 8</code> since one raster cell allocates 8 bytes. However, the memory usage during the prediction process highly varies between different <code>futures</code> and the used learning algorithm. For example, the <code>multisession</code> future generates multiple R sessions and creates copy of the variables for each session. It is even harder to predict how much memory the learning algorithm will need for the prediction. Therefore, we decided that the chunk size should be manually set by user to avoid an error-prone automatic detection of the optimal chunk size.</p>
</div>
<div id="example" class="section level2">
<h2 class="hasAnchor">
<a href="#example" class="anchor"></a>Example</h2>
<p>The package offers functions to create demo raster files in any size.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/raster">raster</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3.mlr-org.com">mlr3</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mlr-org/mlr3spatial">mlr3spatial</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com">data.table</a></span><span class="op">)</span>

<span class="va">stack</span> <span class="op">=</span> <span class="fu">demo_stack</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1000000000</span>, layers<span class="op">=</span><span class="fl">5</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/writeRaster.html">writeRaster</a></span><span class="op">(</span><span class="va">stack</span>, <span class="st">"demo_stack_500mb.tif"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">stack</span><span class="op">)</span></code></pre></div>
<p><code>demo_stack</code> generates a raster stack with 5 layers (4 predictor variables and 1 response variable) with a total size of 500MB. The file is written to disk and the stack is removed to free up memory.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data</span> <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/sampleRandom.html">sampleRandom</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/stack.html">stack</a></span><span class="op">(</span><span class="st">"demo_stack_500mb.tif"</span><span class="op">)</span>, <span class="fl">500</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/names.html">names</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"var"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span>
<span class="va">data</span> <span class="op">=</span> <span class="va">data</span><span class="op">[</span>, <span class="va">var1</span><span class="op">:=</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/factor.html">as.factor</a></span><span class="op">(</span><span class="va">var1</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<p>In order to fit a model, 500 raster cells are randomly sampled. The response variable returned by <code>demo_stack</code> is located in the first column of <code>data</code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">task</span> <span class="op">=</span> <span class="va"><a href="https://mlr3.mlr-org.com/reference/TaskClassif.html">TaskClassif</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>id <span class="op">=</span> <span class="st">"raster"</span>, backend <span class="op">=</span> <span class="va">data</span>, target <span class="op">=</span> <span class="st">"var1"</span>, positive <span class="op">=</span> <span class="st">"1"</span><span class="op">)</span>

<span class="va">learner_svm</span> <span class="op">=</span> <span class="va"><a href="reference/LearnerClassifSVMParallel.html">LearnerClassifSVMParallel</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>
<span class="va">learner_svm</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">task</span>, row_ids <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">500</span><span class="op">)</span></code></pre></div>
<p>A mlr3 <code>task</code> is created and a classification svm is fitted with the randomly sampled raster cells.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data_stack</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/stack.html">stack</a></span><span class="op">(</span><span class="st">"inst/demo_stack_500mb.tif"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/names.html">names</a></span><span class="op">(</span><span class="va">data_stack</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"var"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span>
<span class="va">data_stack</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/addLayer.html">dropLayer</a></span><span class="op">(</span><span class="va">data_stack</span>, <span class="fl">1</span><span class="op">)</span>

<span class="va">reclassify_table</span> <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span>task <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>, raster <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">11</span><span class="op">)</span><span class="op">)</span>
<span class="va">pred</span> <span class="op">=</span> <span class="va"><a href="reference/PredictionRasterClassif.html">PredictionRasterClassif</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">data_stack</span>, <span class="va">task</span>, <span class="va">reclassify_table</span><span class="op">)</span>
<span class="va">pred</span><span class="op">$</span><span class="va">chunksize</span> <span class="op">=</span> <span class="fl">100</span></code></pre></div>
<p>The <code>PredictionRasterClassif</code> class controls the splitting of the raster stack into chunks. The most important parameter is the <code>chunksize</code> which controls size of processed raster chunks. The automatic detection of this parameter is error-prone since different <code>future</code> plans and <code>mlr3</code> learners will consume a highly varying amount of memory.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/future/man/plan.html">plan</a></span><span class="op">(</span><span class="st">"multisession"</span><span class="op">)</span>

<span class="va">ras</span> <span class="op">=</span> <span class="va">pred</span><span class="op">$</span><span class="fu">predict</span><span class="op">(</span><span class="va">learner_svm</span><span class="op">)</span></code></pre></div>
<p>Execute the raster prediction in parallel.</p>
</div>
</div>

  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="links">
<h2>Links</h2>
<ul class="list-unstyled">
<li>Browse source code at <br><a href="https://github.com/mlr-org/mlr3spatial/">https://​github.com/​mlr-org/​mlr3spatial/​</a>
</li>
</ul>
</div>
<div class="license">
<h2>License</h2>
<ul class="list-unstyled">
<li><a href="https://www.r-project.org/Licenses/LGPL-3">LGPL-3</a></li>
</ul>
</div>
<div class="developers">
<h2>Developers</h2>
<ul class="list-unstyled">
<li>Marc Becker <br><small class="roles"> Author, maintainer </small>  </li>
</ul>
</div>

  <div class="dev-status">
<h2>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/mlr-org/mlr3spatial/actions"><img src="https://github.com/mlr-org/mlr3spatial/workflows/tic/badge.svg?branch=main" alt="tic"></a></li>
<li><a href="https://cran.r-project.org/package=mlr3spatial"><img src="https://www.r-pkg.org/badges/version-ago/mlr3spatial" alt="CRAN Status"></a></li>
<li><a href="https://codecov.io/github/mlr-org/mlr3spatial?branch=main"><img src="https://codecov.io/gh/mlr-org/mlr3spatial/branch/main/graph/badge.svg" alt="Coverage status"></a></li>
<li><a href="https://www.codefactor.io/repository/github/mlr-org/mlr3spatial"><img src="https://www.codefactor.io/repository/github/mlr-org/mlr3spatial/badge" alt="CodeFactor"></a></li>
<li><a href="https://lifecycle.r-lib.org/articles/stages.html#experimental"><img src="https://img.shields.io/badge/lifecycle-experimental-orange.svg" alt="Lifecycle: experimental"></a></li>
</ul>
</div>
</div>
</div>


      <footer><div class="copyright">
  <p>Developed by Marc Becker.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
